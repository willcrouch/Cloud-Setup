
sudo apt-get update
sudo apt-get install nginx

# Install R
sudo apt-get install r-base

# Install Shiny & Shiny Server
sudo su - \-c "R -e \"install.packages('shiny', repos='https://cran.rstudio.com/')\""
### For Latest versions: https://www.rstudio.com/products/shiny/download-server/
sudo apt-get install gdebi-core
wget https://download3.rstudio.org/ubuntu-14.04/x86_64/shiny-server-1.5.12.933-amd64.deb
sudo gdebi shiny-server-1.5.12.933-amd64.deb

#test that ip:3838 shows shiny server and ip shows nginx

#Get Certification -- used Certbot
https://certbot.eff.org/
sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot

sudo apt-get install certbot python-certbot-nginx
sudo certbot --nginx
    Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
    - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    1: No redirect - Make no further changes to the webserver configuration.
    2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for
    new sites, or if you're confident your site works on HTTPS. You can undo this
    change by editing your web server's configuration.
   #Chose Redirect (2) 

#Check
sudo certbot renew --dry-run

#setup nginx
sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw allow 3838
sudo ufw enable
sudo ufw status

#restart nginx to start
sudo systemctl restart nginx

#If needed commands
#sudo ufw app list
#sudo ufw disable
#sudo ufw reset

###Check status / restart
# sudo systemctl start nginx 
# sudo systemctl stop nginx 
# sudo systemctl restart nginx
# sudo systemctl status nginx

#Test Point
testtwo.willcrouch.com should redirect to ngnix
testtwo.willcrouch.com:3838

#Review Certs
sudo certbot certificates

# You can do the following steps in WinSCP
sudo chmod 777 /etc/nginx/
sudo chmod 777 /etc/nginx/sites-available/
# modify the nginx.conf in /etc/nginx/ and add a file "sub.sitename.com" to /etc/nginx/sites-available/

sudo nano /etc/nginx/nginx.conf
# in HTTP
    # Map proxy settings for RStudio
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
   
sudo nano /etc/nginx/sites-available/testtwo.willcrouch.com
server {
   listen 80 default_server;
   listen [::]:80 default_server ipv6only=on;
   server_name testtwo.willcrouch.com;
   return 301 https://$server_name$request_uri;
}
server {
   listen 443 ssl;
   server_name testtwo.willcrouch.com;
   
   ssl_certificate /etc/letsencrypt/live/testtwo.willcrouch.com/fullchain.pem;
   ssl_certificate_key /etc/letsencrypt/live/testtwo.willcrouch.com/privkey.pem;
   ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
   ssl_prefer_server_ciphers on;
   ssl_ciphers AES256+EECDH:AES256+EDH:!aNULL;

   location / {
       proxy_pass http://35.196.135.17:3838;
       proxy_redirect http://35.196.135.17:3838/ https://$host/;
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection $connection_upgrade;
       proxy_read_timeout 20d;
   }
}

sudo ln -s /etc/nginx/sites-available/testtwo.willcrouch.com /etc/nginx/sites-enabled/testtwo.willcrouch.com

sudo rm -f /etc/nginx/sites-enabled/default

sudo nginx -t
#Confirm no errors

sudo systemctl restart nginx

# To restart if you need to (config files and all):
# sudo apt-get purge nginx nginx-common
